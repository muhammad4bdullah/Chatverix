<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chatverix — Login</title>

<style>
/* ---------------- Basic Reset ---------------- */
* { margin:0; padding:0; box-sizing:border-box; font-family:Inter,system-ui,Arial,sans-serif; }

:root {
  --bg:#071018;
  --panel:#0f1c22;
  --muted:#9aa7ad;
  --accent:#25D366;
  --error:#ff4b5c;
}

html,body {
  height:100%;
  background: linear-gradient(180deg,#041021,#08121a);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#e8f0f2;
}

.login-card {
  width:100%;
  max-width:420px;
  background:var(--panel);
  padding:32px;
  border-radius:14px;
  text-align:center;
  box-shadow:0 10px 30px rgba(0,0,0,.6);
}

h1 { color:var(--accent); font-size:34px; margin-bottom:8px; }
.muted { color:var(--muted); font-size:14px; margin-bottom:12px; }

input {
  width:100%;
  padding:12px;
  border-radius:8px;
  border:none;
  background:#051017;
  color:#eaf3f5;
  margin-bottom:12px;
}

button {
  width:100%;
  border:none;
  border-radius:10px;
  padding:12px;
  font-weight:600;
  cursor:pointer;
  margin-top:6px;
}

.primary { background:var(--accent); color:#041018; }
.ghost { background:transparent; color:var(--muted); }

.toggle {
  margin-top:16px;
  font-size:14px;
}

.toggle span {
  color:var(--accent);
  cursor:pointer;
  font-weight:600;
}

#errorMsg {
  color: var(--error);
  font-size: 13px;
  margin-bottom: 8px;
  display:none;
}
</style>
</head>

<body>

<div class="login-card">
  <h1 id="title">Login</h1>
  <p class="muted" id="subtitle">Login to your account</p>

  <div id="errorMsg">Error message here</div>

  <!-- GOOGLE LOGIN -->
  <button id="googleBtn" class="primary">Continue with Google</button>

  <p class="muted" style="margin:12px 0">or</p>

  <!-- MANUAL LOGIN / SIGNUP FORM -->
  <form id="authForm">
    <input type="text" id="usernameOrEmail" placeholder="Username / Email" required>
    <input type="password" id="password" placeholder="Password" required>
    <button type="submit" class="primary" id="submitBtn">Login</button>
    <button type="button" class="ghost" id="forgotBtn">Forgot Password?</button>
  </form>

  <div class="toggle">
    <span id="toggleText">Don’t have an account? Sign up</span>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  sendPasswordResetEmail,
  sendEmailVerification
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getDatabase, ref, set, get, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* ---------------- FIREBASE ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAEWxTJ1loQkXM1ShwAAF1J15RQLlCgdGM",
  authDomain: "msgapp-262c9.firebaseapp.com",
  projectId: "msgapp-262c9",
  databaseURL: "https://msgapp-262c9-default-rtdb.asia-southeast1.firebasedatabase.app"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

/* ---------------- UI STATE ---------------- */
let isSignup = false;

const title = document.getElementById("title");
const subtitle = document.getElementById("subtitle");
const toggleText = document.getElementById("toggleText");
const submitBtn = document.getElementById("submitBtn");
const usernameOrEmailInput = document.getElementById("usernameOrEmail");
const passwordInput = document.getElementById("password");
const errorMsg = document.getElementById("errorMsg");
const forgotBtn = document.getElementById("forgotBtn");

/* ---------------- TOGGLE LOGIN / SIGNUP ---------------- */
toggleText.onclick = () => {
  isSignup = !isSignup;
  errorMsg.style.display = "none";
  if(isSignup){
    title.innerText = "Sign Up";
    subtitle.innerText = "Create a new account";
    submitBtn.innerText = "Sign Up";
    forgotBtn.style.display = "none";
    toggleText.innerText = "Already have an account? Login";
  } else {
    title.innerText = "Login";
    subtitle.innerText = "Login to your account";
    submitBtn.innerText = "Login";
    forgotBtn.style.display = "inline-block";
    toggleText.innerText = "Don’t have an account? Sign up";
  }
};

/* ---------------- GOOGLE AUTH ---------------- */
document.getElementById("googleBtn").onclick = async () => {
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    const userRef = ref(db, `users/${user.uid}`);
    const snap = await get(userRef);

    if(!snap.exists()){
      // New user → prompt to set username, nickname, password
      const username = prompt("Set your username (unique):");
      const nickname = prompt("Set your nickname:");
      const password = prompt("Set a password for manual login:");
      await set(userRef, {
        uid: user.uid,
        email: user.email,
        username,
        nickname,
        password, // store hashed ideally
        photoURL: user.photoURL || "https://i.ibb.co/7QpKsCX/default-avatar.png",
        createdAt: Date.now()
      });
    } else {
      // Existing user → update lastLogin
      await update(userRef, { lastLogin: Date.now() });
    }

    window.location.href = "index.html";
  } catch(err){
    errorMsg.style.display = "block";
    errorMsg.innerText = err.message;
  }
};

/* ---------------- MANUAL LOGIN / SIGNUP ---------------- */
document.getElementById("authForm").onsubmit = async (e) => {
  e.preventDefault();
  errorMsg.style.display = "none";

  const identifier = usernameOrEmailInput.value.trim();
  const password = passwordInput.value;

  try {
    if(isSignup){
      const email = identifier.includes("@") ? identifier : prompt("Enter your email:");
      const username = identifier.includes("@") ? prompt("Set a username:") : identifier;
      const nickname = prompt("Set your nickname:");
      const userCred = await createUserWithEmailAndPassword(auth, email, password);

      await set(ref(db, `users/${userCred.user.uid}`), {
        uid: userCred.user.uid,
        email,
        username,
        nickname,
        password, // store hashed ideally
        photoURL: "https://i.ibb.co/7QpKsCX/default-avatar.png",
        createdAt: Date.now()
      });

      // Email verification
      await sendEmailVerification(userCred.user);
      alert("Verification email sent. Please verify before logging in.");

    } else {
      // LOGIN
      let userSnap = null;
      if(identifier.includes("@")){
        // Login via email
        const q = query(ref(db,"users"), orderByChild("email"), equalTo(identifier));
        const snapshot = await get(q);
        snapshot.forEach(snap => { userSnap = snap.val(); });
      } else {
        // Login via username
        const q = query(ref(db,"users"), orderByChild("username"), equalTo(identifier));
        const snapshot = await get(q);
        snapshot.forEach(snap => { userSnap = snap.val(); });
      }

      if(!userSnap) throw new Error("User not found");
      if(userSnap.password !== password) throw new Error("Incorrect password");

      window.location.href = "index.html";
    }
  } catch(err){
    errorMsg.style.display = "block";
    errorMsg.innerText = err.message;
  }
};

/* ---------------- FORGOT PASSWORD ---------------- */
forgotBtn.onclick = async () => {
  const email = prompt("Enter your email to reset password:");
  if(email){
    try{
      await sendPasswordResetEmail(auth, email);
      alert("Password reset email sent!");
    } catch(err){
      errorMsg.style.display = "block";
      errorMsg.innerText = err.message;
    }
  }
};
</script>

</body>
</html>
